############################
# Servicios (solo backend)
############################
services:
  # -----------------------------
  # Odoo Web (puertos internos)
  # -----------------------------
  web:
    image: "odoo-pers:18"
    container_name: "odoo-18"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - odoo_network_18
    ports:
      - "18069:8069"
      - "15679:5679"
    volumes:
      - "./v18/config:/etc/odoo"
    environment:
      - HOST=db
      - USER=odoo
      - PASSWORD=123456
    command: [
      "python", "-m", "debugpy", "--listen", "0.0.0.0:5679",
      "--wait-for-client", "odoo-bin", "-c", "/etc/odoo/odoo.conf"
    ]
    stop_grace_period: 60s
    # El comando ahora está en el Dockerfile

  # -----------------------------
  # PostgreSQL con pgvector
  # -----------------------------
  db:
    image: postgres:16
    container_name: "odoo-db${VERSION}"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=123456
      - PGDATA=/var/lib/postgresql/data/pgdata
    networks:
      - odoo_network_18
    volumes:
      - "./v${VERSION}/pgdata/data:/var/lib/postgresql/data/pgdata"
      - "./v${VERSION}/pgdata/init:/docker-entrypoint-initdb.d"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    stop_grace_period: 60s

  # -----------------------------
  # Redis con contraseña
  # -----------------------------
  redis:
    image: redis:7
    container_name: odoo_redis
    restart: always
    networks:
      - odoo_network_18
    secrets:
      - redis_password
    command: >
      sh -c '
        REDIS_PASS=$$(cat /run/secrets/redis_password 2>/dev/null || echo "") &&
        mkdir -p /usr/local/etc/redis &&
        if [ -n "$$REDIS_PASS" ]; then
          echo "requirepass $$REDIS_PASS" > /usr/local/etc/redis/redis.conf &&
          echo "protected-mode yes" >> /usr/local/etc/redis/redis.conf
        fi &&
        exec redis-server /usr/local/etc/redis/redis.conf --save 60 1 --loglevel warning
      '
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    stop_grace_period: 30s

  # -----------------------------
  # n8n (puerto interno)
  # -----------------------------
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: "n8n-container"
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - odoo_network_18
    ports:
      - "5678:5678"  # ← NGINX → n8n.jumpjibe.com
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_HOST=${DB_HOST}
      - DB_POSTGRESDB_PORT=${DB_PORT}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD_FILE=${POSTGRES_PASSWORD_FILE}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD_FILE=${N8N_PASSWORD_FILE}
      - N8N_ENCRYPTION_KEY_FILE=${N8N_ENCRYPTION_KEY_FILE}
      - N8N_HOST=n8n.jumpjibe.com
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.jumpjibe.com/
      - N8N_EDITOR_BASE_URL=https://n8n.jumpjibe.com/
      - N8N_RUNNERS_ENABLED=${N8N_RUNNERS_ENABLED}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    volumes:
      - "./v${VERSION}/n8n_data:/home/node/.n8n"
    depends_on:
      db:
        condition: service_healthy
    secrets:
      - postgres_password
      - n8n_password
      - n8n_encryption_key
    stop_grace_period: 60s

############################
# Secrets
############################
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  n8n_password:
    file: ./secrets/n8n_password.txt
  n8n_encryption_key:
    file: ./secrets/n8n_encryption_key.txt

############################
# Redes
############################
networks:
  odoo_network_18:
    driver: bridge
    name: odoo_network_18