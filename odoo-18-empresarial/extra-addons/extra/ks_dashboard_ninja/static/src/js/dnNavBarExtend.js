/** @odoo-module **/

import { patch } from "@web/core/utils/patch";
import { MenuDropdown } from '@web/webclient/navbar/navbar';
import { onWillStart, onWillUnmount, onWillRender, useEffect, onMounted, useRef, onPatched } from "@odoo/owl";
import { NavBar } from "@web/webclient/navbar/navbar";
import { ActionContainer } from "@web/webclient/actions/action_container";
import { ActivityMenu } from "@mail/core/web/activity_menu";
import { UserMenu } from "@web/webclient/user_menu/user_menu";
import { MessagingMenu } from "@mail/core/public_web/messaging_menu";



const dnMenuIcons = {
            'My Dashboards': {
                'templateIcon': `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M10.54 13.4533C10.3667 13.4533 10.1867 13.4466 9.99338 13.4266C9.64671 13.4 9.25338 13.3333 8.84671 13.2333L7.72671 12.9666C4.65338 12.24 3.64671 10.6133 4.36671 7.54664L5.02005 4.7533C5.16671 4.11997 5.34005 3.60664 5.55338 3.17997C6.70005 0.813303 8.89338 1.02664 10.4534 1.3933L11.5667 1.6533C13.1267 2.01997 14.1134 2.59997 14.6667 3.48664C15.2134 4.3733 15.3 5.5133 14.9334 7.0733L14.28 9.85997C13.7067 12.3 12.5134 13.4533 10.54 13.4533ZM8.74671 2.16664C7.63338 2.16664 6.92671 2.62664 6.45338 3.6133C6.28005 3.9733 6.12671 4.41997 5.99338 4.97997L5.34005 7.7733C4.74671 10.2933 5.43338 11.3933 7.95338 11.9933L9.07338 12.26C9.43338 12.3466 9.77338 12.4 10.08 12.4266C11.8934 12.6066 12.7934 11.8133 13.3 9.6333L13.9534 6.84664C14.2534 5.55997 14.2134 4.65997 13.8134 4.0133C13.4134 3.36664 12.6267 2.92664 11.3334 2.62664L10.22 2.36664C9.66671 2.2333 9.17338 2.16664 8.74671 2.16664Z" fill=""></path>
                                        <path d="M5.55341 14.8334C3.84008 14.8334 2.74674 13.8067 2.04674 11.64L1.19341 9.0067C0.246742 6.07337 1.09341 4.42003 4.01341 3.47337L5.06674 3.13337C5.41341 3.0267 5.67341 2.95337 5.90674 2.91337C6.10007 2.87337 6.28674 2.9467 6.40008 3.10003C6.51341 3.25337 6.53341 3.45337 6.45341 3.6267C6.28008 3.98003 6.12674 4.4267 6.00008 4.9867L5.34674 7.78003C4.75341 10.3 5.44007 11.4 7.96007 12L9.08008 12.2667C9.44007 12.3534 9.78008 12.4067 10.0867 12.4334C10.3001 12.4534 10.4734 12.6 10.5334 12.8067C10.5867 13.0134 10.5067 13.2267 10.3334 13.3467C9.89341 13.6467 9.34008 13.9 8.64008 14.1267L7.58674 14.4734C6.82008 14.7134 6.15341 14.8334 5.55341 14.8334ZM5.18674 4.1467L4.32674 4.4267C1.94674 5.19337 1.38008 6.31337 2.14674 8.70003L3.00008 11.3334C3.77341 13.7134 4.89341 14.2867 7.27341 13.52L8.32674 13.1734C8.36674 13.16 8.40007 13.1467 8.44007 13.1334L7.73341 12.9667C4.66008 12.24 3.65341 10.6134 4.37341 7.5467L5.02674 4.75337C5.07341 4.54003 5.12674 4.33337 5.18674 4.1467Z" fill=""></path>
                                        <path d="M11.6599 7.00664C11.6199 7.00664 11.5799 6.99997 11.5332 6.99331L8.29992 6.17331C8.03325 6.10664 7.87325 5.83331 7.93992 5.56664C8.00658 5.29997 8.27992 5.13997 8.54658 5.20664L11.7799 6.02664C12.0466 6.09331 12.2066 6.36664 12.1399 6.63331C12.0866 6.85331 11.8799 7.00664 11.6599 7.00664Z" fill=""></path>
                                        <path d="M9.70643 9.25993C9.66643 9.25993 9.62643 9.25326 9.57976 9.2466L7.63976 8.75326C7.37309 8.6866 7.21309 8.41326 7.27976 8.1466C7.34643 7.87993 7.61976 7.71993 7.88643 7.7866L9.82643 8.27993C10.0931 8.3466 10.2531 8.61993 10.1864 8.8866C10.1331 9.11326 9.93309 9.25993 9.70643 9.25993Z" fill=""></path>
                                    </svg>`
            },
            'Quick Access': {
                'Overview': `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.2133 8.50006H10C8.34 8.50006 7.5 7.56006 7.5 5.70006V3.78672C7.5 3.10672 7.58 2.13339 8.28667 1.60006C8.88 1.16006 9.73333 1.12672 10.9933 1.49339C12.6467 1.97339 14.0267 3.35339 14.5067 5.00672C14.8733 6.26006 14.84 7.12006 14.4 7.70672C13.8667 8.42006 12.8933 8.50006 12.2133 8.50006ZM9.52 2.24006C9.24667 2.24006 9.03333 2.29339 8.89333 2.40006C8.63333 2.59339 8.50667 3.04672 8.50667 3.78672V5.70672C8.50667 7.20006 9.08 7.50672 10.0067 7.50672H12.22C12.9533 7.50672 13.4067 7.38006 13.6067 7.12006C13.84 6.81339 13.82 6.20006 13.56 5.30006C13.1733 3.98672 12.04 2.84672 10.7267 2.46672C10.2333 2.31339 9.83333 2.24006 9.52 2.24006Z" fill=""></path>
                                <path d="M7.37992 15.1667C7.02659 15.1667 6.66659 15.1401 6.30659 15.0801C3.57992 14.6401 1.35992 12.4267 0.919922 9.70005C0.353255 6.19338 2.61325 2.88672 6.07326 2.18005C6.34659 2.12672 6.60659 2.30005 6.66659 2.56672C6.71992 2.84005 6.54659 3.10005 6.27992 3.16005C3.35326 3.76005 1.43326 6.56005 1.91992 9.54005C2.29326 11.8467 4.16659 13.7201 6.47326 14.0934C9.46659 14.5734 12.2599 12.6467 12.8533 9.70672C12.9066 9.43338 13.1733 9.26005 13.4399 9.31338C13.7133 9.36672 13.8866 9.63338 13.8333 9.90005C13.1999 13.0134 10.4799 15.1667 7.37992 15.1667Z" fill=""></path>
                            </svg>`,
                'Inbox': `<svg width="16" height="16" viewBox="0 0 16 16" fill="" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.3335 14.1667H4.66683C4.3935 14.1667 4.16683 13.94 4.16683 13.6667C4.16683 13.3934 4.3935 13.1667 4.66683 13.1667H11.3335C13.2402 13.1667 14.1668 12.24 14.1668 10.3334V5.66671C14.1668 3.76004 13.2402 2.83337 11.3335 2.83337H4.66683C2.76016 2.83337 1.8335 3.76004 1.8335 5.66671C1.8335 5.94004 1.60683 6.16671 1.3335 6.16671C1.06016 6.16671 0.833496 5.94004 0.833496 5.66671C0.833496 3.23337 2.2335 1.83337 4.66683 1.83337H11.3335C13.7668 1.83337 15.1668 3.23337 15.1668 5.66671V10.3334C15.1668 12.7667 13.7668 14.1667 11.3335 14.1667Z" fill=""></path>
                                <path d="M7.99969 8.57998C7.43969 8.57998 6.87302 8.40665 6.43969 8.05331L4.35302 6.38665C4.13969 6.21331 4.09969 5.89998 4.27302 5.68665C4.44636 5.47331 4.75968 5.43332 4.97302 5.60665L7.05969 7.27332C7.56635 7.67998 8.42635 7.67998 8.93302 7.27332L11.0197 5.60665C11.233 5.43332 11.553 5.46665 11.7197 5.68665C11.893 5.89998 11.8597 6.21998 11.6397 6.38665L9.55301 8.05331C9.12635 8.40665 8.55969 8.57998 7.99969 8.57998Z" fill=""></path>
                                <path d="M5.3335 11.5H1.3335C1.06016 11.5 0.833496 11.2733 0.833496 11C0.833496 10.7267 1.06016 10.5 1.3335 10.5H5.3335C5.60683 10.5 5.8335 10.7267 5.8335 11C5.8335 11.2733 5.60683 11.5 5.3335 11.5Z" fill=" "></path>
                                <path d="M3.3335 8.83337H1.3335C1.06016 8.83337 0.833496 8.60671 0.833496 8.33337C0.833496 8.06004 1.06016 7.83337 1.3335 7.83337H3.3335C3.60683 7.83337 3.8335 8.06004 3.8335 8.33337C3.8335 8.60671 3.60683 8.83337 3.3335 8.83337Z" fill=""></path>
                            </svg>`,
            },
            'Configuration': {
                'Dashboards': `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M13.18 9.16671H10.4867C9.14667 9.16671 8.5 8.54671 8.5 7.26671V2.73337C8.5 1.45337 9.15333 0.833374 10.4867 0.833374H13.18C14.52 0.833374 15.1667 1.45337 15.1667 2.73337V7.26671C15.1667 8.54671 14.5133 9.16671 13.18 9.16671ZM10.4867 1.83337C9.64 1.83337 9.5 2.06004 9.5 2.73337V7.26671C9.5 7.94004 9.64 8.16671 10.4867 8.16671H13.18C14.0267 8.16671 14.1667 7.94004 14.1667 7.26671V2.73337C14.1667 2.06004 14.0267 1.83337 13.18 1.83337H10.4867Z" fill=""></path>
                                        <path d="M13.18 15.1666H10.4867C9.14667 15.1666 8.5 14.5466 8.5 13.2666V12.0666C8.5 10.7866 9.15333 10.1666 10.4867 10.1666H13.18C14.52 10.1666 15.1667 10.7866 15.1667 12.0666V13.2666C15.1667 14.5466 14.5133 15.1666 13.18 15.1666ZM10.4867 11.1666C9.64 11.1666 9.5 11.3933 9.5 12.0666V13.2666C9.5 13.94 9.64 14.1666 10.4867 14.1666H13.18C14.0267 14.1666 14.1667 13.94 14.1667 13.2666V12.0666C14.1667 11.3933 14.0267 11.1666 13.18 11.1666H10.4867Z" fill=""></path>
                                        <path d="M5.5135 15.1667H2.82016C1.48016 15.1667 0.833496 14.5467 0.833496 13.2667V8.73337C0.833496 7.45337 1.48683 6.83337 2.82016 6.83337H5.5135C6.8535 6.83337 7.50016 7.45337 7.50016 8.73337V13.2667C7.50016 14.5467 6.84683 15.1667 5.5135 15.1667ZM2.82016 7.83337C1.9735 7.83337 1.8335 8.06004 1.8335 8.73337V13.2667C1.8335 13.94 1.9735 14.1667 2.82016 14.1667H5.5135C6.36016 14.1667 6.50016 13.94 6.50016 13.2667V8.73337C6.50016 8.06004 6.36016 7.83337 5.5135 7.83337H2.82016Z" fill=""></path>
                                        <path d="M5.5135 5.83337H2.82016C1.48016 5.83337 0.833496 5.21337 0.833496 3.93337V2.73337C0.833496 1.45337 1.48683 0.833374 2.82016 0.833374H5.5135C6.8535 0.833374 7.50016 1.45337 7.50016 2.73337V3.93337C7.50016 5.21337 6.84683 5.83337 5.5135 5.83337ZM2.82016 1.83337C1.9735 1.83337 1.8335 2.06004 1.8335 2.73337V3.93337C1.8335 4.60671 1.9735 4.83337 2.82016 4.83337H5.5135C6.36016 4.83337 6.50016 4.60671 6.50016 3.93337V2.73337C6.50016 2.06004 6.36016 1.83337 5.5135 1.83337H2.82016Z" fill=""></path>
                                    </svg>`,
                'Dashboard Layouts': `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7.85993 7.91996C7.49993 7.91996 7.13327 7.85329 6.8466 7.72663L2.91327 5.97996C1.91327 5.53329 1.7666 4.93329 1.7666 4.60663C1.7666 4.27996 1.91327 3.67996 2.91327 3.23329L6.8466 1.48663C7.4266 1.22663 8.29994 1.22663 8.87994 1.48663L12.8199 3.23329C13.8133 3.67329 13.9666 4.27996 13.9666 4.60663C13.9666 4.93329 13.8199 5.53329 12.8199 5.97996L8.87994 7.72663C8.5866 7.85996 8.2266 7.91996 7.85993 7.91996ZM7.85993 2.29329C7.63327 2.29329 7.41327 2.32663 7.25327 2.39996L3.31993 4.14663C2.91327 4.33329 2.7666 4.51996 2.7666 4.60663C2.7666 4.69329 2.91327 4.88663 3.31327 5.06663L7.2466 6.81329C7.5666 6.95329 8.1466 6.95329 8.4666 6.81329L12.4066 5.06663C12.8133 4.88663 12.9599 4.69329 12.9599 4.60663C12.9599 4.51996 12.8133 4.32663 12.4066 4.14663L8.47327 2.39996C8.31327 2.33329 8.0866 2.29329 7.85993 2.29329Z" fill="#"></path>
                                            <path d="M8 11.3934C7.74667 11.3934 7.49333 11.34 7.25333 11.2334L2.72667 9.22004C2.04 8.92004 1.5 8.08671 1.5 7.33337C1.5 7.06004 1.72667 6.83337 2 6.83337C2.27333 6.83337 2.5 7.06004 2.5 7.33337C2.5 7.70004 2.8 8.16004 3.13333 8.31337L7.66 10.3267C7.87333 10.42 8.12 10.42 8.34 10.3267L12.8667 8.31337C13.2 8.16671 13.5 7.70004 13.5 7.33337C13.5 7.06004 13.7267 6.83337 14 6.83337C14.2733 6.83337 14.5 7.06004 14.5 7.33337C14.5 8.08671 13.96 8.92004 13.2733 9.22671L8.74667 11.24C8.50667 11.34 8.25333 11.3934 8 11.3934Z" fill=""></path>
                                            <path d="M8 14.7267C7.74667 14.7267 7.49333 14.6734 7.25333 14.5667L2.72667 12.5534C1.98 12.22 1.5 11.48 1.5 10.66C1.5 10.3867 1.72667 10.16 2 10.16C2.27333 10.16 2.5 10.3934 2.5 10.6667C2.5 11.0867 2.74667 11.4734 3.13333 11.6467L7.66 13.66C7.87333 13.7534 8.12 13.7534 8.34 13.66L12.8667 11.6467C13.2533 11.4734 13.5 11.0934 13.5 10.6667C13.5 10.3934 13.7267 10.1667 14 10.1667C14.2733 10.1667 14.5 10.3934 14.5 10.6667C14.5 11.4867 14.02 12.2267 13.2733 12.56L8.74667 14.5734C8.50667 14.6734 8.25333 14.7267 8 14.7267Z" fill=""></path>
                                        </svg>`,
                'Import Dashboards': `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="import-svg">
                                            <path d="M6 7.33337V11.3334L7.33333 10" fill="#4B5563"/>
                                            <path d="M6 7.33337V11.3334L7.33333 10" stroke="#4B5563" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M6.00033 11.3333L4.66699 10" stroke="#4B5563" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M14.6663 6.66671V10C14.6663 13.3334 13.333 14.6667 9.99967 14.6667H5.99967C2.66634 14.6667 1.33301 13.3334 1.33301 10V6.00004C1.33301 2.66671 2.66634 1.33337 5.99967 1.33337H9.33301" stroke="#4B5563" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M14.6663 6.66671H11.9997C9.99967 6.66671 9.33301 6.00004 9.33301 4.00004V1.33337L14.6663 6.66671Z" stroke="#4B5563" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>`,
            }
        }

export function dnNavBarAddClasses(){
    document.querySelector('body')?.classList.add('ks_body_class');
    document.querySelector('.o_main_navbar')?.classList.add('navbar', 'navbar-expand-md');
    document.querySelector('.ks-mobile-burger-menu')?.classList.remove('d-none');
    document.querySelector('.mobile-burger-menu-default')?.classList.add('d-none');
}



export function dnNavBarRemoveClasses(){
    document.querySelector('body')?.classList.remove('ks_body_class');
    document.querySelector('.o_main_navbar')?.classList.remove('navbar', 'navbar-expand-md');
    document.querySelector('.ks-mobile-burger-menu')?.classList.add('d-none');
    document.querySelector('.mobile-burger-menu-default')?.classList.remove('d-none');
}


patch(MenuDropdown.prototype,{
    setup() {
        super.setup();
        this.dnMenuRef = useRef("menuRef");
        useEffect(
            () => {
                if(this.props?.slots?.toggler?.__ctx?.section?.childrenTree?.length >= 9){
                    $(this.rootRef?.el)?.addClass(' mega-menu dash-dd');
                    $(this.togglerRef?.el)?.addClass(' ks-nav-link');
                }
                else{
                    $(this.rootRef?.el)?.addClass(' dash-dd');
                    $(this.togglerRef?.el)?.addClass(' ks-nav-link');
                }
            },
            () => []
        );
        onPatched( () => {
            this.addIcons();
        });
    },

    addIcons(){
        let menuName = this.togglerRef.el?.textContent;
        if( menuName && this.dnMenuRef.el && this?.env.services.menu.getCurrentApp?.().xmlid === "ks_dashboard_ninja.board_menu_root"){
            let dropdownItems = this.dnMenuRef.el.querySelectorAll('.dropdown-item')
            dropdownItems.forEach( (dropdownItem) => {
                let dropdownName = menuName !== 'My Dashboards' ? dropdownItem.textContent : 'templateIcon'
                let icon = "<span class='me-2 dash-dd-icons'>" + dnMenuIcons[menuName][dropdownName] + "</span>"
                dropdownItem.insertAdjacentHTML("afterbegin", icon);

                let currentActiveMenu = this.env.services.router.current?.hash.menu_id
                if(currentActiveMenu && parseInt(dropdownItem.dataset.section) === currentActiveMenu)
                    dropdownItem.classList.add('nav-active');
            });
        }
    }

});

patch(NavBar.prototype,{
    setup(){
        super.setup();
        onMounted( () => {
            let apps_menu_icon = this.root.el?.querySelector('.o_navbar_apps_menu .o-dropdown');
            if(apps_menu_icon)
                apps_menu_icon.innerHTML += `<div class="ks-apps-menu-icon d-none">
                                                 <span class="img-bg">
                                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M16.475 9.37508H13.1083C11.4333 9.37508 10.625 8.63341 10.625 7.10008V3.31675C10.625 1.78341 11.4417 1.04175 13.1083 1.04175H16.475C18.15 1.04175 18.9583 1.78341 18.9583 3.31675V7.09175C18.9583 8.63341 18.1417 9.37508 16.475 9.37508ZM13.1083 2.29175C11.9917 2.29175 11.875 2.60841 11.875 3.31675V7.09175C11.875 7.80841 11.9917 8.11675 13.1083 8.11675H16.475C17.5917 8.11675 17.7083 7.80008 17.7083 7.09175V3.31675C17.7083 2.60008 17.5917 2.29175 16.475 2.29175H13.1083Z" fill=""/>
                                                        <path d="M16.475 18.9583H13.1083C11.4333 18.9583 10.625 18.1417 10.625 16.475V13.1083C10.625 11.4333 11.4417 10.625 13.1083 10.625H16.475C18.15 10.625 18.9583 11.4417 18.9583 13.1083V16.475C18.9583 18.1417 18.1417 18.9583 16.475 18.9583ZM13.1083 11.875C12.125 11.875 11.875 12.125 11.875 13.1083V16.475C11.875 17.4583 12.125 17.7083 13.1083 17.7083H16.475C17.4583 17.7083 17.7083 17.4583 17.7083 16.475V13.1083C17.7083 12.125 17.4583 11.875 16.475 11.875H13.1083Z" fill=""/>
                                                        <path d="M6.8915 9.37508H3.52484C1.84984 9.37508 1.0415 8.63341 1.0415 7.10008V3.31675C1.0415 1.78341 1.85817 1.04175 3.52484 1.04175H6.8915C8.5665 1.04175 9.37484 1.78341 9.37484 3.31675V7.09175C9.37484 8.63341 8.55817 9.37508 6.8915 9.37508ZM3.52484 2.29175C2.40817 2.29175 2.2915 2.60841 2.2915 3.31675V7.09175C2.2915 7.80841 2.40817 8.11675 3.52484 8.11675H6.8915C8.00817 8.11675 8.12484 7.80008 8.12484 7.09175V3.31675C8.12484 2.60008 8.00817 2.29175 6.8915 2.29175H3.52484Z" fill=""/>
                                                        <path d="M6.8915 18.9583H3.52484C1.84984 18.9583 1.0415 18.1417 1.0415 16.475V13.1083C1.0415 11.4333 1.85817 10.625 3.52484 10.625H6.8915C8.5665 10.625 9.37484 11.4417 9.37484 13.1083V16.475C9.37484 18.1417 8.55817 18.9583 6.8915 18.9583ZM3.52484 11.875C2.5415 11.875 2.2915 12.125 2.2915 13.1083V16.475C2.2915 17.4583 2.5415 17.7083 3.52484 17.7083H6.8915C7.87484 17.7083 8.12484 17.4583 8.12484 16.475V13.1083C8.12484 12.125 7.87484 11.875 6.8915 11.875H3.52484Z" fill=""/>
                                                    </svg>
                                                </span>
                                             </div>`
        });
    },

    async adapt(){
        if(this.currentApp?.xmlid === "ks_dashboard_ninja.board_menu_root" || this.actionService?.currentController?.action.tag === 'ks_dashboard_ninja'){
            if(!document.querySelector('body').classList.contains('ks_body_class'))
                dnNavBarAddClasses();
        }
        else{
            if(document.querySelector('body').classList.contains('ks_body_class'))
                dnNavBarRemoveClasses();
        }
        return super.adapt();
    },

    onNavBarDropdownItemSelection(menu) {
        if(this.currentApp?.xmlid === "ks_dashboard_ninja.board_menu_root"){
             if(!document.body.classList?.contains('ks_body_class')){
                document.querySelector('body').classList.add('ks_body_class')
             }
        }
        else{
            if(document.querySelector('body').classList.contains('ks_body_class'))
                dnNavBarRemoveClasses();
        }
        super.onNavBarDropdownItemSelection(menu);
    }

});

patch(ActionContainer.prototype,{
    setup(){
        super.setup();
        onPatched( () => {
                if(this?.env.services.menu.getCurrentApp?.()?.xmlid === "ks_dashboard_ninja.board_menu_root" || this.info?.componentProps?.action?.tag === 'ks_dashboard_ninja'){
                    if(!document.querySelector('body').classList.contains('ks_body_class'))
                        dnNavBarAddClasses();
                }
                else if(this?.env.services.menu.getCurrentApp?.()?.xmlid !== "ks_dashboard_ninja.board_menu_root" || this.info?.componentProps?.action?.tag !== 'ks_dashboard_ninja'){
                    if(document.querySelector('body').classList.contains('ks_body_class'))
                        dnNavBarRemoveClasses();
                }
        });
    },

});

