services:
  postgres:
    image: pgvector/pgvector:pg12
    container_name: chatwoot-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: chatwoot
      POSTGRES_PASSWORD: chatwoot123
      POSTGRES_DB: chatwoot_production
    volumes:
      - ./v18/chatwoot_pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatwoot -d chatwoot_production"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - chatwoot-net
    
  redis:
    image: redis:7-alpine
    container_name: chatwoot-redis
    restart: unless-stopped
    command: redis-server --requirepass redis123
    volumes:
      - ./v18/chatwoot_redis_data:/data
    ports:
      - "6380:6379"
    networks:
      - chatwoot-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rails:
    image: chatwoot/chatwoot:latest
    container_name: chatwoot-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy  # Usar healthcheck de Redis
    environment:
      # Configuración crítica de Rails
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      NODE_ENV: production
      
      # Variables de PostgreSQL
      POSTGRES_USER: chatwoot
      POSTGRES_PASSWORD: chatwoot123
      POSTGRES_DB: chatwoot_production
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      
      # DATABASE_URL
      DATABASE_URL: postgresql://chatwoot:chatwoot123@postgres:5432/chatwoot_production
      
      # Redis
      REDIS_PASSWORD: redis123
      REDIS_URL: redis://:redis123@redis:6379
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      # Claves secretas
      SECRET_KEY_BASE: 99f4fa1f8fadd2125a12148ccf962c5d1ae16592a7da11ef9fc795f6a5c68e97737746c53ce0ecbc45d64235e349b879312d0a28431c81c2a59165d2d7077c54
      RAILS_MASTER_KEY: 99f4fa1f8fadd2125a12148ccf962c5d1ae16592a7da11ef9fc795f6a5c68e97737746c53ce0ecbc45d64235e349b879312d0a28431c81c2a59165d2d7077c54
      
      # Configuración de la aplicación
      FRONTEND_URL: https://chatwoot.jumpjibe.com
      FORCE_SSL: "false"
      DEFAULT_LOCALE: es
      ENABLE_ACCOUNT_SIGNUP: "true"
      
      # Otros ajustes importantes
      RAILS_LOG_TO_STDOUT: "true"
      RAILS_SERVE_STATIC_FILES: "true"
    ports:
      - "3000:3000"
    volumes:
      - ./v18/chatwoot_storage:/app/storage
      - ./v18/chatwoot_logs:/app/log
      - ./v18/chatwoot_tmp:/app/tmp
    networks:
      - chatwoot-net
    command: >
      sh -c "
        # Limpiar PID anterior si existe
        echo 'Limpiando archivos anteriores...' &&
        rm -f /app/tmp/pids/server.pid 2>/dev/null &&
        
        # Esperar PostgreSQL
        echo 'Esperando PostgreSQL...' &&
        until pg_isready -h postgres -p 5432 -U chatwoot -d chatwoot_production 2>/dev/null; do
          echo 'PostgreSQL no listo, esperando...' &&
          sleep 5;
        done &&
        echo 'PostgreSQL listo ✓' &&
        
        # Verificar Redis usando un método simple (no redis-cli)
        echo 'Verificando Redis...' &&
        # Esperar un momento para que Redis esté completamente listo
        sleep 10 &&
        
        # Ejecutar migraciones
        echo 'Ejecutando migraciones de base de datos...' &&
        bundle exec rails db:chatwoot_prepare &&
        
        # Iniciar servidor
        echo '=== CHATWOOT INICIANDO ===' &&
        echo 'Accede en: https://chatwoot.jumpjibe.com' &&
        bundle exec rails server -p 3000 -b 0.0.0.0
      "

  sidekiq:
    image: chatwoot/chatwoot:latest
    container_name: chatwoot-sidekiq
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    environment:
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      
      # PostgreSQL
      POSTGRES_USER: chatwoot
      POSTGRES_PASSWORD: chatwoot123
      POSTGRES_DB: chatwoot_production
      POSTGRES_HOST: postgres
      DATABASE_URL: postgresql://chatwoot:chatwoot123@postgres:5432/chatwoot_production
      
      # Redis
      REDIS_PASSWORD: redis123
      REDIS_URL: redis://:redis123@redis:6379
      
      # Claves secretas
      SECRET_KEY_BASE: 99f4fa1f8fadd2125a12148ccf962c5d1ae16592a7da11ef9fc795f6a5c68e97737746c53ce0ecbc45d64235e349b879312d0a28431c81c2a59165d2d7077c54
      RAILS_MASTER_KEY: 99f4fa1f8fadd2125a12148ccf962c5d1ae16592a7da11ef9fc795f6a5c68e97737746c53ce0ecbc45d64235e349b879312d0a28431c81c2a59165d2d7077c54
    volumes:
      - ./v18/chatwoot_storage:/app/storage
      - ./v18/chatwoot_logs:/app/log
      - ./v18/chatwoot_tmp:/app/tmp
    networks:
      - chatwoot-net
    command: bundle exec sidekiq -C config/sidekiq.yml

networks:
  chatwoot-net:
    driver: bridge