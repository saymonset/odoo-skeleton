services:
  # PostgreSQL con pgvector
  db:
    image: ankane/pgvector:latest
    container_name: "odoo-db18-n8n"
    environment:
      POSTGRES_DB: dbodoo18
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    networks:
      - odoo_network_18
    volumes:
      - "./v18/odoo_n8n_pgdata/data:/var/lib/postgresql/data/pgdata"
      - "./v18/odoo_n8n_pgdata/init:/docker-entrypoint-initdb.d"
    secrets:
      - postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U odoo -d dbodoo18"]
      interval: 5s
      timeout: 5s
      retries: 10
    stop_grace_period: 60s

  # Redis
    # Redis (servicio compartido con n8n y Chatwoot)
  redis:
    image: redis:7-alpine
    container_name: odoo_redis
    restart: always
    networks:
      - odoo_network_18
    # ðŸ”´ Exponer puerto para debugging
    ports:
      - "6379:6379"
    # ðŸ”´ ConfiguraciÃ³n optimizada
    command: >
      redis-server 
      --requirepass redis123 
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --databases 16
      --save 900 1
      --save 300 10
      --save 60 10000
      --loglevel notice
      --tcp-keepalive 300
      --timeout 0
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    stop_grace_period: 30s
    # ðŸ”´ Volumen opcional para persistencia
    volumes:
      - "./v18/redis_data:/data" 

  # Odoo Web
  web:
    image: "odoo-pers:18"
    container_name: "odoo-18-web"
    user: "1001:1001"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - odoo_network_18
    ports:
      - "18069:8069"
      - "18072:8072"
    volumes:
      - "./v18/odoo-web-data:/var/lib/odoo"
      - "./v18/config:/etc/odoo"
      - "./v18/addons/extra:/opt/odoo/custom-addons/extra"
      - "./v18/addons/oca:/opt/odoo/custom-addons/oca"
      - "./v18/addons/enterprise:/opt/odoo/custom-addons/enterprise"
      - "./v18/logs:/var/log/odoo"
      - "./v18/filestore:/var/lib/odoo/.local/share/Odoo"
    environment:
      HOST: db
      USER: odoo
      PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    stop_grace_period: 60s

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  redis_password:
    file: ./secrets/redis_password.txt

# CORRECCIÃ“N: Elimina la definiciÃ³n de red aquÃ­, ya se define en el principal
# networks:
#   odoo_network_18:
#     driver: bridge
#     name: odoo_network_18