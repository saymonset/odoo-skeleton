<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
<!-- Template para el VoiceRecorder -->
    <t t-name="chatter_voice_note.VoiceRecorder" owl="1">
        <div class="o_container p-4">
            <!-- Estado -->
            <div class="alert alert-info">
                <strong>Estado:</strong> <t t-esc="state.debugInfo"/>
            </div>

            <!-- Error -->
            <t t-if="state.error">
                <div class="alert alert-danger">
                    <strong>Error:</strong> <t t-esc="state.error"/>
                </div>
            </t>

            <!-- Sin notas: bot√≥n de grabaci√≥n -->
            <t t-if="audioNoteManager.state.notes.length == 0">
                <h2>Voice Recorder</h2>
                <button type="button" t-on-click="toggleRecording" class="btn btn-lg"
                        t-att-class="state.recording ? 'btn-warning' : 'btn-primary'">
                    <t t-esc="state.recording ? 'Stop Recording' : 'Start Recording'"/>
                </button>
            </t>

            <!-- Con notas: lista + reproductor -->
            <t t-if="audioNoteManager.state.notes.length > 0">
                <div class="mt-3">
                    <h4>Notas grabadas: <t t-esc="audioNoteManager.state.notes.length"/></h4>

                    <t t-foreach="sortedNotes" t-as="note" t-key="note.id">
                        <div class="mb-2 p-2 border">
                            <strong><t t-esc="note.name"/></strong>

                            <!-- REPRODUCTOR CORRECTO -->
                            <audio controls="controls" class="d-block mt-1 w-100">
                                <source t-att-src="note.url" type="audio/webm"/>
                                Tu navegador no soporta audio.
                            </audio>

                            <button type="button" class="btn btn-sm btn-danger mt-1"
                                    t-on-click="deleteNote" t-att-data-note-id="note.id">
                                Eliminar
                            </button>
                        </div>
                    </t>

                    <!-- Contactos -->
                    <div class="mt-3">
                        <h4>Contactos: <t t-esc="contactManager.state.selectedContacts.length"/></h4>
                        <input class="form-control mb-2" placeholder="Buscar contactos..."
                               t-att-value="contactManager.state.searchTerm" t-on-input="onSearchInput"/>

                        <t t-if="contactManager.state.availableContacts.length > 0">
                            <div class="list-group mb-2">
                                <t t-foreach="contactManager.state.availableContacts" t-as="contact" t-key="contact.id">
                                    <a href="#" class="list-group-item list-group-item-action"
                                       t-on-click="onAddContact" t-att-data-contact-id="contact.id">
                                        <t t-esc="contact.name"/>
                                    </a>
                                </t>
                            </div>
                        </t>

                        <t t-if="contactManager.state.selectedContacts.length > 0">
                            <div class="list-group">
                                <t t-foreach="contactManager.state.selectedContacts" t-as="contact" t-key="contact.id">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <t t-esc="contact.name"/>
                                        <button type="button" class="btn btn-sm btn-danger"
                                                t-on-click="onRemoveContact" t-att-data-contact-id="contact.id">X</button>
                                    </div>
                                </t>
                            </div>
                        </t>

                        <!-- Enviar -->
                        <t t-if="contactManager.state.selectedContacts.length > 0">
                            <div class="mt-3">
                                <button type="button" 
                                        t-on-click="sendToN8N" 
                                        t-att-disabled="state.isSending"
                                        t-att-class="state.isSending ? 'btn-secondary' : 'btn-success'"
                                        class="btn btn-lg">
                                    <t t-esc="state.isSending ? 'Enviando...' : 'Enviar a IA'"/>
                                </button>
                            </div>
                        </t>
                    </div>
                </div>
            </t>

            <!-- Respuestas -->
            <div class="row mt-4">
                <div class="col-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <span>Mensaje Final</span>
                            <t t-if="state.final_message and !state.editingFinalMessage">
                                <button type="button" t-on-click="startEditingFinalMessage" 
                                        class="btn btn-sm btn-light">
                                    ‚úèÔ∏è Editar
                                </button>
                            </t>
                        </div>
                        <div class="card-body">
                            <t t-if="state.editingFinalMessage">
                                <textarea t-model="state.editedFinalMessage" 
                                          class="form-control" 
                                          rows="4"
                                          placeholder="Edita el mensaje final aqu√≠..."></textarea>
                                <div class="mt-2 d-flex gap-2">
                                    <button type="button" t-on-click="saveFinalMessage" 
                                            class="btn btn-success btn-sm">
                                        ‚úÖ Aceptar
                                    </button>
                                    <button type="button" t-on-click="cancelEditingFinalMessage" 
                                            class="btn btn-secondary btn-sm">
                                        ‚ùå Cancelar
                                    </button>
                                </div>
                            </t>
                            <t t-elif="state.final_message">
                                <div class="final-message-content">
                                    <t t-esc="state.final_message"/>
                                </div>
                            </t>
                            <t t-else="">
                                <span class="text-muted">Esperando mensaje...</span>
                            </t>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">Respuesta IA</div>
                        <div class="card-body">
                            <t t-if="state.answer_ia">
                                <div class="answer-ia-content">
                                    <t t-esc="state.answer_ia"/>
                                </div>
                            </t>
                            <t t-else="">
                                <span class="text-muted">Esperando respuesta IA...</span>
                            </t>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reporte M√©dico Modal -->
            <t t-if="state.showMedicalReport">
                <MedicalReport 
                    content="formattedReportContent"
                    title="state.reportTitle"
                    onClose="closeMedicalReport"
                />
            </t>

            <!-- Verificar manual -->
            <t t-if="currentRequestId &amp;&amp; !state.final_message">
                <div class="mt-3">
                    <button type="button" t-on-click="checkResponse" class="btn btn-warning btn-sm">
                        Verificar Respuesta Manualmente
                    </button>
                </div>
            </t>
        </div>
    </t>

   <!-- Template para MedicalReport  -->
<!-- Template para MedicalReport CORREGIDO -->
<t t-name="chatter_voice_note.MedicalReport" owl="1">
    <div class="medical-report-container">
        <div class="medical-report bg-white p-4 shadow-lg">
            <!-- Header del Reporte -->
            <div class="report-header d-flex justify-content-between align-items-start border-bottom pb-3 mb-4">
                <div class="report-title-section">
                    <h1 class="report-title text-primary mb-1">
                        <t t-esc="reportTitle"/>
                    </h1>
                    <p class="text-muted mb-0">Reporte generado autom√°ticamente</p>
                </div>
                <div class="report-logo">
                    <div class="logo-placeholder bg-light rounded p-3 text-center border">
                        <i class="fa fa-hospital text-primary fa-2x mb-2"></i>
                        <div class="small fw-bold">CENTRO M√âDICO</div>
                    </div>
                </div>
            </div>

            <!-- Contenido del Reporte -->
            <div class="report-content mb-4">
                <div class="medical-content text-center py-4 px-3 bg-light rounded border">
                    <!-- üî• CORRECCI√ìN: t-raw -> t-out -->
                    <div t-out="props.content" class="medical-text fs-5 lh-base"/>
                </div>
            </div>

            <!-- Footer del Reporte -->
            <div class="report-footer border-top pt-3">
                <div class="row">
                    <div class="col-6">
                        <div class="doctor-signature">
                            <p class="mb-1 fw-bold">Dr. Alejandro Rodr√≠guez</p>
                            <p class="text-muted small mb-0">M√©dico Especialista</p>
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <p class="text-muted mb-0">
                            <strong>Fecha:</strong> 
                            <!-- üî• CORRECCI√ìN: currentDate sin par√©ntesis -->
                            <span t-esc="currentDate"/>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Acciones del Reporte -->
            <div class="report-actions mt-4 pt-3 border-top">
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                            t-on-click="props.onClose">
                        ‚ùå Cerrar
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            t-on-click="printReport">
                        üñ®Ô∏è Imprimir
                    </button>
                    <button type="button" class="btn btn-primary btn-sm"
                            t-on-click="downloadPDF">
                        üìÑ Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</t>
</templates>