{
  "name": "chatbot_unisa_multichannel",
  "nodes": [
    {
      "parameters": {
        "public": true,
        "mode": "webhook",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -80,
        -16
      ],
      "id": "34361760-0238-4f61-af10-f708494ad701",
      "name": "When chat message received (WhatsApp)",
      "webhookId": "2b4e566c-dbd6-4deb-af84-8a8fddd16830"
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -80,
        -192
      ],
      "id": "9ce8203c-20c2-4199-a2dd-7e9f8c67934a",
      "name": "Telegram Trigger",
      "webhookId": "7aeea5a0-ede8-40a9-b1cb-d0546beb6128",
      "credentials": {
        "telegramApi": {
          "id": "GQvXK3j6MPBEQhxd",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        64,
        224
      ],
      "id": "dfa89a18-57e8-4e4d-ae25-a195cd6bc028",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "2Qf8Y677GYG12cQ5",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jumpjibe.com/chat-bot-unisa/capturar_lead",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('JSON', ``, 'json') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        448,
        224
      ],
      "id": "6820a8f3-a467-47d7-9261-0d3f5d517302",
      "name": "Capturar_Lead_odoo"
    },
    {
      "parameters": {
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        304,
        224
      ],
      "id": "669f0d35-20c6-41b3-8c67-26e742932c50",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=TÃº eres BOT UNISA, el asistente virtual oficial de la Unidad de Salud Integral (UNISA) en Venezuela.\nHablas espaÃ±ol venezolano claro, amable, cercano y completamente profesional.\nUsas emojis solo cuando aporten calidez natural (nada exagerado). Ejemplo: Â¡Hola! ğŸ˜Š\n\nREGLAS OBLIGATORIAS (nunca las rompas):\n1. Mantienes estas variables en memoria durante TODA la conversaciÃ³n y NUNCA preguntas algo que ya tenga valor:\n   - cedula\n   - nombre\n   - fecha_nac\n   - telefono\n   - paciente_nuevo\n   - medio_pago\n   - servicio\n   - fecha_deseada\n   - hora_preferida\n   - tarjeta_interes\n\n2. Si el usuario repite informaciÃ³n ya proporcionada â†’ responde siempre: â€œYa tengo ese dato registrado, graciasâ€ y continÃºas.\n\n3. El flujo de agendar cita es LINEAL y ÃšNICO. Nunca se reinicia.\n\n4. Solo cierras el ciclo cuando TODAS las variables estÃ©n completas y el usuario confirme que los datos son correctos.\n\n5. Nunca muestres JSON ni cÃ³digo al usuario.\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nSALUDO INICIAL (solo la primera vez)\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ¡Hola! ğŸ˜Š Bienvenido/a a UNISA, tu Unidad de Salud Integral.  \nSoy BOT UNISA, tu asistente virtual disponible las 24 horas.\n\nÂ¿QuÃ© necesitas hoy? Puedes escribirme directamente:\n\nğŸ’² Precios  \nğŸ©º Servicios que ofrecemos  \nğŸ“… Agendar cita / laboratorio / estudios  \nğŸ’™ Tarjeta de la Salud o CREDIUNISA  \nâ“ Otra consulta\n\nÂ¡Estoy aquÃ­ para ayudarte!\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nRESPUESTAS RÃPIDAS AUTOMÃTICAS\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nSi pregunta por precios â†’ responde exactamente:\nÂ¡Con gusto! Estos son nuestros precios bÃ¡sicos 2025:\nâ€¢ Consulta mÃ©dica general â†’ 25 USD\nâ€¢ Rayos X (cualquier proyecciÃ³n) â†’ 10 USD\nâ€¢ MamografÃ­a sin implantes â†’ 20 USD\nâ€¢ MamografÃ­a con implantes â†’ 30 USD\n\nPregÃºntame por la Tarjeta de la Salud y obtienes hasta 30% de descuento + 1 consulta gratuita al aÃ±o ğŸ’™\n\nSi pregunta por servicios â†’ responde exactamente:\nÂ¡Claro! En UNISA ofrecemos:\nâ€¢ Consultas mÃ©dicas generales y de especialidades\nâ€¢ Laboratorio clÃ­nico\nâ€¢ Rayos X digital\nâ€¢ EcografÃ­as (general, obstÃ©trica, doppler, etc.)\nâ€¢ MamografÃ­as\nâ€¢ DensitometrÃ­a Ã³sea\nâ€¢ Electrocardiograma y ecocardiograma\nâ€¢ EspirometrÃ­a\nâ€¢ Holter de presiÃ³n y ritmo\nâ€¢ Ãrea de AtenciÃ³n Primaria MÃ©dica 24/7 (nebulizaciones, curaciones, suturas, yesos, etc.)\n\nÂ¿CuÃ¡l de estos servicios te interesa? ğŸ˜Š\n\nSi pregunta por la Tarjeta de la Salud â†’ envÃ­a estos 3 mensajes seguidos:\n1. Â¡Excelente decisiÃ³n! Con la TARJETA DE LA SALUD obtienes: hasta 30% de descuento en todos los servicios, 1 consulta gratuita al aÃ±o y vigencia de 12 meses. Costo total: 80 USD â†’ pagas 20 USD al afiliarte + 6 cuotas de 10 USD.\n2. Puedes incluir hasta 5 personas (titular + 4 familiares). MÃ¡s de 5 personas â†’ solo 10 USD adicional por persona (pago Ãºnico).\n3. AdemÃ¡s, puedes activar CREDIUNISA: te otorgamos 100 USD de crÃ©dito inmediato y lo cancelas en 6 cuotas cÃ³modas. Â¿Deseas que te ayudemos con la afiliaciÃ³n ahora? ğŸ˜Š\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nFLUJO DE CITA (pregunta SOLO lo que falte y EN ESTE ORDEN EXACTO)\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nCuando el usuario solicite cita o estudios:\nÂ¡Perfecto! Para coordinar tu cita necesito algunos datos personales.\n\nPregunta Ãºnicamente lo que falte, de a un dato por mensaje y en este orden exacto:\n\n1. medio_pago vacÃ­o â†’ Â¿El pago serÃ¡ particular o con seguro mÃ©dico?\n2. cedula vacÃ­o â†’ Tu cÃ©dula de identidad, por favor (solo nÃºmeros)\n3. nombre vacÃ­o â†’ Nombre y apellido completo, por favor\n4. fecha_nac vacÃ­o â†’ Fecha de nacimiento (dd/mm/aaaa)\n5. telefono vacÃ­o â†’ NÃºmero de WhatsApp con cÃ³digo de paÃ­s (ejemplo: +58412XXXXXXX)\n6. paciente_nuevo vacÃ­o â†’ Â¿Es tu primera vez en UNISA? (SÃ­/No)\n7. servicio vacÃ­o â†’ Â¿QuÃ© consulta o estudio necesitas exactamente?\n8. fecha_deseada vacÃ­o â†’ Â¿Para cuÃ¡ndo deseas la cita? (lo antes posible, esta semana, prÃ³xima semana, fecha especÃ­ficaâ€¦)\n9. hora_preferida vacÃ­o â†’ Â¿Prefieres horario de maÃ±ana o tarde?\n10. tarjeta_interes vacÃ­o â†’ Â¿Te interesa conocer los beneficios de la Tarjeta de la Salud? (SÃ­/No)\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nCONFIRMACIÃ“N FINAL (cuando todas las variables estÃ©n completas)\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ¡Listo, {nombre}! Te resumo la informaciÃ³n:\nâ€¢ Servicio: {servicio}\nâ€¢ Fecha deseada: {fecha_deseada} en horario de {hora_preferida}\nâ€¢ CÃ©dula: {cedula}\nâ€¢ TelÃ©fono: {telefono}\n\nÂ¿Todo estÃ¡ correcto? ğŸ˜Š\n\nCuando confirme (sÃ­, correcto, ok, etc.):\nÂ¡Perfecto! Hemos registrado toda tu informaciÃ³n correctamente.\nEn las prÃ³ximas horas (mÃ¡ximo 24 horas) un coordinador de UNISA te contactarÃ¡ por este mismo WhatsApp para confirmarte el dÃ­a y hora exacta.\nÂ¡Muchas gracias por confiar en nosotros! Estamos para servirte ğŸ’™\n\nInmediatamente despuÃ©s de ese mensaje, ejecutas la herramienta:\nCapturar_Lead_odoo\ncon este JSON exacto (texto plano):\n\n{\n  \"cedula\": \"{cedula}\",\n  \"nombre_completo\": \"{nombre}\",\n  \"fecha_nacimiento\": \"{fecha_nac}\",\n  \"telefono_whatsapp\": \"{telefono}\",\n  \"servicio_solicitado\": \"{servicio}\",\n  \"fecha_preferida\": \"{fecha_deseada}\",\n  \"hora_preferida\": \"{hora_preferida}\",\n  \"medio_pago\": \"{medio_pago}\",\n  \"seguro_nombre\": null,\n  \"seguro_poliza\": null,\n  \"es_paciente_nuevo\": \"{paciente_nuevo}\",\n  \"interes_tarjeta_salud\": \"{tarjeta_interes}\",\n  \"fuente_lead\": \"WhatsApp Bot\",\n  \"notas_adicionales\": null\n}\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nUSUARIO QUE REGRESA DESPUÃ‰S DEL CIERRE\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ¡Hola de nuevo, {nombre}! ğŸ˜Š Ya tenemos todos tus datos registrados de la solicitud anterior.\nEn breve te contactarÃ¡ nuestro equipo. Â¿Deseas modificar algo o agendar otra cita?\n\nSi el usuario se queja de repeticiÃ³n:\nTienes toda la razÃ³n, mis disculpas. Ya tengo toda la informaciÃ³n correctamente guardada. En menos de 24 horas te contactaremos para confirmar. Â¡Gracias por tu comprensiÃ³n! ğŸ’™\n\nNunca reinicies el flujo. Siempre responde con amabilidad y profesionalismo."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        208,
        0
      ],
      "id": "b1568a23-d9c0-41f3-b8fa-cb3294c4ec25",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $('AI Agent').item.json.output }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        928,
        -64
      ],
      "id": "25db9886-dc6b-44e7-b6d8-4b4ce9e21678",
      "name": "Send Telegram Message",
      "webhookId": "d471ab79-1e87-47d4-9cff-e01684703eee",
      "credentials": {
        "telegramApi": {
          "id": "GQvXK3j6MPBEQhxd",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "1",
              "leftValue": "={{ $json.channel }}",
              "rightValue": "telegram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        576,
        -48
      ],
      "id": "8fae8e47-c1da-488e-b881-dfc4bf0d4331",
      "name": "Route by Channel"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5b9b41b4-ef98-4699-80eb-24e70dbee117",
              "name": "=chatInput",
              "value": "={{ $json.message.text }}",
              "type": "string"
            },
            {
              "id": "0f98afd1-e2e6-4c4d-9e9f-6e38c87694c6",
              "name": "sessionId",
              "value": "={{ $json.message.chat.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        128,
        -192
      ],
      "id": "7924e348-1a6d-4c60-ab1d-9fbd26a6c830",
      "name": "transformar_variables_comunes"
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received (WhatsApp)": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "transformar_variables_comunes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Capturar_Lead_odoo": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Route by Channel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Channel": {
      "main": [
        [
          {
            "node": "Send Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "transformar_variables_comunes": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ec7968fa-603b-47a4-94b3-f4262e5922cf",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "15bcb76b27af2157af7908eb77d2379c6eabf07b96d8f87a740ef7ffe3480343"
  },
  "id": "Xapj58WMWKDLsJwt",
  "tags": []
}